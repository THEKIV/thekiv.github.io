<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Список дел</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root {
      --bg-color: #f4f4f4;
      --card-bg: white;
      --text-color: black;
      --btn-bg: #007bff;
      --btn-hover: #0056b3;
      --list-bg: #eee;
      --completed-bg: #ddd;
      --date-color: #666;
      --priority-low: green;
      --priority-medium: gold;
      --priority-high: red;
      --delete-btn-bg: red;
      --delete-btn-hover: darkred;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #eee;
      --btn-bg: #2979ff;
      --btn-hover: #1c54b4;
      --list-bg: #2a2a2a;
      --completed-bg: #3a3a3a;
      --date-color: #aaa;
      --delete-btn-bg: crimson;
      --delete-btn-hover: firebrick;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
      margin: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    .todo-container {
      background: var(--card-bg);
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      margin: auto;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 1.2em;
      padding-top: 10px;
    }

    .sticky-panel {
      position: sticky;
      top: 0;
      background: var(--card-bg);
      z-index: 999;
      padding: 15px 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #todo-form,
    .modal-box form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    input[type="text"], select, .flatpickr-input {
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: var(--card-bg);
      color: var(--text-color);
      height: 36px;
      width: 100%;
      box-sizing: border-box;
    }

    .filters,
    .sort-buttons,
    .extra-buttons,
    .priority-filters,
    .scheme-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    button {
      min-width: 90px;
      height: 36px;
      padding: 0 10px;
      border: none;
      background-color: var(--btn-bg);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: var(--btn-hover);
    }

    button.delete-btn {
      background-color: var(--delete-btn-bg);
      color: white;
    }

    button.delete-btn:hover {
      background-color: var(--delete-btn-hover);
    }

    ul {
      list-style-type: none;
      padding: 15px;
      margin: 0;
      max-height: 60vh;
      overflow-y: auto;
    }

    li {
      background: var(--list-bg);
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    li.completed {
      text-decoration: line-through;
      color: var(--date-color);
      background-color: var(--completed-bg);
      transform: scale(0.98);
    }

    .task-priority {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .priority-low { background-color: var(--priority-low); }
    .priority-medium { background-color: var(--priority-medium); }
    .priority-high { background-color: var(--priority-high); }

    .group-header {
      font-weight: bold;
      margin: 10px 0 5px 0;
      font-size: 14px;
      border-bottom: 1px solid var(--date-color);
      padding-bottom: 5px;
    }

    .stats {
      font-size: 12px;
      color: var(--date-color);
      margin-left: 8px;
    }

    .total-stats {
      font-size: 14px;
      text-align: center;
      margin: 10px 0;
      color: var(--date-color);
    }

    /* Модальное окно */
    .modal,
    .confirm-modal,
    .settings-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show,
    .confirm-modal.show,
    .settings-modal.show {
      display: flex;
    }

    .modal-box,
    .confirm-box,
    .settings-box {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .buttons-row {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .undo-toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 4px;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .undo-toast.show {
      opacity: 1;
      visibility: visible;
    }

    @media (max-width: 600px) {
      .todo-container {
        padding: 10px;
      }

      .modal-box,
      .confirm-box,
      .settings-box {
        width: 95%;
        padding: 20px;
      }

      .filters button,
      .sort-buttons button,
      .extra-buttons button,
      .priority-filters button,
      .scheme-buttons button {
        min-width: 80px;
        font-size: 13px;
      }

      .buttons-row button {
        font-size: 13px;
        height: 32px;
        padding: 0 8px;
      }

      .undo-toast {
        width: 90%;
        max-width: 90%;
        font-size: 14px;
      }

      .group-header {
        font-size: 14px;
      }

      input[type="text"],
      select,
      .flatpickr-input {
        font-size: 14px;
        height: 36px;
      }

      .total-stats {
        font-size: 14px;
      }

      .sticky-panel {
        padding: 10px;
      }

      .theme-toggle {
        position: static;
        display: flex;
        justify-content: center;
        margin-top: 10px;
      }

      .theme-toggle button {
        width: auto;
        min-width: 90px;
        justify-content: center;
      }
    }
  </style>
</head>
<body data-theme="light" data-scheme="default">
  <div class="todo-container">
    <div class="sticky-panel">
      <h1 id="app-title">Мои дела</h1>
      <form id="todo-form">
        <input type="text" id="todo-input" placeholder="Что нужно сделать?" required />
        <input type="text" id="todo-date" placeholder="Выберите дату" />
        <select id="todo-priority">
          <option value="low">Низкий</option>
          <option value="medium">Средний</option>
          <option value="high">Высокий</option>
        </select>
        <button type="submit"><i class="fas fa-plus"></i>Добавить</button>
      </form>
      <div class="total-stats" id="totalStats">Загрузка...</div>
      <div class="filters" id="filters">
        <button data-filter="all" class="active"><i class="fas fa-list"></i>Все</button>
        <button data-filter="active"><i class="fas fa-spinner"></i>Активные</button>
        <button data-filter="completed"><i class="fas fa-check-circle"></i>Выполненные</button>
      </div>
      <div class="priority-filters">
        <button data-priority="all" class="active"><i class="fas fa-filter"></i>Все приоритеты</button>
        <button data-priority="low"><i class="fas fa-arrow-down"></i>Низкий</button>
        <button data-priority="medium"><i class="fas fa-equals"></i>Средний</button>
        <button data-priority="high"><i class="fas fa-arrow-up"></i>Высокий</button>
      </div>
      <div class="sort-buttons">
        <button id="sort-soonest"><i class="fas fa-clock"></i>Ближайшие</button>
        <button id="sort-furthest"><i class="fas fa-hourglass-end"></i>Отдалённые</button>
        <button id="sort-by-priority"><i class="fas fa-exclamation-triangle"></i>По приоритету</button>
      </div>
      <ul id="todo-list"></ul>
    </div>
  </div>

  <!-- Модальное окно редактирования -->
  <div class="modal" id="editModal">
    <div class="modal-box">
      <h3 style="margin: 0 0 10px 0;">Редактировать задачу</h3>
      <input type="text" id="edit-text" placeholder="Текст задачи" required />
      <input type="text" id="edit-date" placeholder="Дата" />
      <select id="edit-priority">
        <option value="low">Низкий</option>
        <option value="medium">Средний</option>
        <option value="high">Высокий</option>
      </select>
      <div class="buttons-row">
        <button id="saveEditBtn"><i class="fas fa-save"></i>Сохранить</button>
        <button id="closeEditBtn"><i class="fas fa-times"></i>Закрыть</button>
        <button id="moveTomorrowBtn"><i class="fas fa-calendar-alt"></i>Перенести на завтра</button>
      </div>
    </div>
  </div>

  <!-- Подтверждение удаления -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-box">
      <p>Вы уверены?</p>
      <div class="buttons-row">
        <button id="confirmDelete"><i class="fas fa-trash"></i>Да</button>
        <button id="cancelDelete"><i class="fas fa-times"></i>Нет</button>
      </div>
    </div>
  </div>

  <!-- Настройки -->
  <div class="modal settings-modal" id="settingsModal">
    <div class="modal-box settings-box">
      <h3 style="margin: 0 0 15px 0;">Настройки</h3>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <label>
          Тема:
          <select id="themeSelect">
            <option value="light">Светлая</option>
            <option value="dark">Тёмная</option>
          </select>
        </label>
        <label>
          Цветовая схема:
          <select id="schemeSelect">
            <option value="default">По умолчанию</option>
            <option value="blue">Голубая</option>
            <option value="orange">Оранжевая</option>
            <option value="purple">Фиолетовая</option>
          </select>
        </label>
      </div>
      <div class="buttons-row">
        <button id="saveSettingsBtn"><i class="fas fa-save"></i>Сохранить</button>
        <button id="closeSettingsBtn"><i class="fas fa-times"></i>Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Восстановление удалённой задачи -->
  <div class="undo-toast" id="undoToast">
    Задача удалена
    <button id="undoBtn" style="background: green; color: white; border: none; padding: 4px 8px;">
      <i class="fas fa-undo"></i> Отменить
    </button>
  </div>

  <!-- Flatpickr JS + Локализация RU -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const translations = {
        ru: {
          title: 'Мои дела',
          placeholder: 'Что нужно сделать?',
          add: 'Добавить',
          all: 'Все',
          active: 'Активные',
          completed: 'Выполненные',
          low: 'Низкий',
          medium: 'Средний',
          high: 'Высокий',
          soonest: 'Ближайшие',
          furthest: 'Отдалённые',
          byPriority: 'По приоритету',
          edit: 'Редактировать',
          delete: 'Удалить',
          confirmDelete: 'Да',
          cancelDelete: 'Нет',
          undo: 'Отменить',
          save: 'Сохранить',
          close: 'Закрыть',
          tomorrow: 'Перенести на завтра',
          settings: 'Настройки',
          theme: 'Тема',
          colorScheme: 'Цветовая схема'
        }
      };

      function updateInterfaceLanguage() {
        const t = translations.ru;
        document.getElementById("app-title").textContent = t.title;
        document.getElementById("todo-input").placeholder = t.placeholder;
        document.querySelector('.filters button[data-filter="all"]').innerHTML = `<i class="fas fa-list"></i>${t.all}`;
        document.querySelector('.filters button[data-filter="active"]').innerHTML = `<i class="fas fa-spinner"></i>${t.active}`;
        document.querySelector('.filters button[data-filter="completed"]').innerHTML = `<i class="fas fa-check-circle"></i>${t.completed}`;
        document.querySelector('.priority-filters button[data-priority="low"]').innerHTML = `<i class="fas fa-arrow-down"></i>${t.low}`;
        document.querySelector('.priority-filters button[data-priority="medium"]').innerHTML = `<i class="fas fa-equals"></i>${t.medium}`;
        document.querySelector('.priority-filters button[data-priority="high"]').innerHTML = `<i class="fas fa-arrow-up"></i>${t.high}`;
        document.getElementById("sort-soonest").innerHTML = `<i class="fas fa-clock"></i>${t.soonest}`;
        document.getElementById("sort-furthest").innerHTML = `<i class="fas fa-hourglass-end"></i>${t.furthest}`;
        document.getElementById("sort-by-priority").innerHTML = `<i class="fas fa-exclamation-triangle"></i>${t.byPriority}`;
      }

      const form = document.getElementById('todo-form');
      const input = document.getElementById('todo-input');
      const dateInput = document.getElementById('todo-date');
      const todoList = document.getElementById('todo-list');
      const totalStats = document.getElementById('totalStats');
      const filters = document.querySelectorAll('.filters button');
      const priorityFilters = document.querySelectorAll('.priority-filters button');

      const confirmModal = document.getElementById('confirmModal');
      const confirmDeleteBtn = document.getElementById('confirmDelete');
      const cancelDeleteBtn = document.getElementById('cancelDelete');
      const editModal = document.getElementById('editModal');
      const editTextInput = document.getElementById('edit-text');
      const editDateInput = document.getElementById('edit-date');
      const editPriorityInput = document.getElementById('edit-priority');
      const saveEditBtn = document.getElementById('saveEditBtn');
      const closeEditBtn = document.getElementById('closeEditBtn');
      const moveTomorrowBtn = document.getElementById('moveTomorrowBtn');
      const undoToast = document.getElementById('undoToast');
      const undoBtn = document.getElementById('undoBtn');

      const settingsBtn = document.getElementById('settingsBtn');
      const settingsModal = document.getElementById('settingsModal');
      const themeSelect = document.getElementById('themeSelect');
      const schemeSelect = document.getElementById('schemeSelect');
      const saveSettingsBtn = document.getElementById('saveSettingsBtn');
      const closeSettingsBtn = document.getElementById('closeSettingsBtn');

      let todos = JSON.parse(localStorage.getItem('todos')) || [];
      let filter = localStorage.getItem('filter') || 'all';
      let priorityFilter = 'all';
      let deleteIndex = null;
      let deletedTodo = null;
      let editIndex = null;
      let currentSort = 'soonest';

      const savedTheme = localStorage.getItem('theme') || 'light';
      const savedScheme = localStorage.getItem('scheme') || 'default';

      themeSelect.value = savedTheme;
      schemeSelect.value = savedScheme;

      document.body.setAttribute('data-theme', savedTheme);
      if (savedScheme !== 'default') {
        document.body.setAttribute('data-scheme', savedScheme);
      }

      updateInterfaceLanguage();

      // Инициализация календаря
      flatpickr(dateInput, {
        altInput: true,
        altFormat: "d.m.Y",
        dateFormat: "Y-m-d",
        locale: "ru"
      });

      flatpickr(editDateInput, {
        altInput: true,
        altFormat: "d.m.Y",
        dateFormat: "Y-m-d",
        locale: "ru"
      });

      function saveTodos() {
        localStorage.setItem('todos', JSON.stringify(todos));
      }

      function debounce(func, delay) {
        let timer;
        return function () {
          clearTimeout(timer);
          timer = setTimeout(() => func.apply(this, arguments), delay);
        };
      }

      const debouncedSave = debounce(saveTodos, 500);

      function getTotalStats() {
        const activeCount = todos.filter(t => !t.completed).length;
        const completedCount = todos.filter(t => t.completed).length;
        return `Всего: ${todos.length} | Активных: ${activeCount} | Выполненных: ${completedCount}`;
      }

      function renderTotalStats() {
        if (totalStats) totalStats.textContent = getTotalStats();
      }

      function setFilter(filterValue) {
        filter = filterValue;
        localStorage.setItem('filter', filterValue);
        updateFilterButtons();
        renderTodos();
      }

      function updateFilterButtons() {
        document.querySelectorAll('.filters button').forEach(btn => btn.classList.remove('active'));
        const activeButton = document.querySelector(`.filters button[data-filter="${filter}"]`);
        if (activeButton) activeButton.classList.add('active');
      }

      function renderTodos() {
        let filtered = [...todos];
        if (filter === 'active') filtered = filtered.filter(t => !t.completed);
        else if (filter === 'completed') filtered = filtered.filter(t => t.completed);

        if (priorityFilter !== 'all') {
          filtered = filtered.filter(t => t.priority === priorityFilter);
        }

        if (currentSort === 'soonest') {
          filtered.sort((a, b) => new Date(a.date || '9999-12-31') - new Date(b.date || '9999-12-31'));
        } else if (currentSort === 'furthest') {
          filtered.sort((a, b) => new Date(b.date || '0001-01-01') - new Date(a.date || '0001-01-01'));
        } else if (currentSort === 'priority') {
          const order = { low: 0, medium: 1, high: 2 };
          filtered.sort((a, b) => order[a.priority] - order[b.priority]);
        }

        todoList.innerHTML = '';
        const grouped = {};
        for (const todo of filtered) {
          const day = todo.date ? todo.date : 'Без даты';
          if (!grouped[day]) grouped[day] = [];
          grouped[day].push(todo);
        }

        for (const date in grouped) {
          const tasks = grouped[date];
          const header = document.createElement('li');
          header.className = 'group-header';
          header.textContent = date;

          const stats = document.createElement('span');
          stats.className = 'stats';
          const active = tasks.filter(t => !t.completed).length;
          const completed = tasks.filter(t => t.completed).length;
          stats.textContent = `(${active}, ${completed})`;
          header.appendChild(stats);
          todoList.appendChild(header);

          for (const todo of tasks) {
            const realIndex = todos.indexOf(todo);
            const li = document.createElement('li');
            li.dataset.index = realIndex;
            if (todo.completed) li.classList.add('completed');

            const priorityDot = document.createElement('span');
            priorityDot.className = 'task-priority';
            priorityDot.classList.add(
              todo.priority === 'low' ? 'priority-low' :
              todo.priority === 'medium' ? 'priority-medium' : 'priority-high'
            );

            const span = document.createElement('span');
            span.textContent = todo.text;

            const editBtn = document.createElement('button');
            editBtn.innerHTML = '<i class="fas fa-edit"></i>Редактировать';
            editBtn.className = 'edit-btn';
            editBtn.addEventListener('click', e => {
              e.stopPropagation();
              editIndex = realIndex;
              editTextInput.value = todo.text;
              editDateInput.value = todo.date || '';
              editPriorityInput.value = todo.priority || 'low';
              editModal.style.display = 'flex';
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>Удалить';
            deleteBtn.className = 'delete-btn';
            deleteBtn.addEventListener('click', e => {
              e.stopPropagation();
              deleteIndex = realIndex;
              confirmModal.style.display = 'flex';
            });

            li.appendChild(priorityDot);
            li.appendChild(span);
            li.appendChild(editBtn);
            li.appendChild(deleteBtn);
            todoList.appendChild(li);
          }
        }

        renderTotalStats();
      }

      // Обработчики событий
      form.addEventListener('submit', e => {
        e.preventDefault();
        const text = input.value.trim();
        const date = dateInput.value;
        const priority = document.getElementById('todo-priority').value;
        if (text) {
          todos.push({ text, date, priority, completed: false });
          debouncedSave();
          renderTodos();
          input.value = '';
          dateInput.value = '';
        }
      });

      saveEditBtn.addEventListener('click', () => {
        const text = editTextInput.value.trim();
        const date = editDateInput.value;
        const priority = editPriorityInput.value;
        if (text && editIndex !== null) {
          todos[editIndex].text = text;
          todos[editIndex].date = date;
          todos[editIndex].priority = priority;
          debouncedSave();
          renderTodos();
          editModal.style.display = 'none';
          editIndex = null;
        }
      });

      closeEditBtn.addEventListener('click', () => {
        editModal.style.display = 'none';
        editIndex = null;
      });

      moveTomorrowBtn.addEventListener('click', () => {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        editDateInput.value = tomorrow.toISOString().split('T')[0];
      });

      confirmDeleteBtn.addEventListener('click', () => {
        if (deleteIndex !== null) {
          deletedTodo = { ...todos[deleteIndex], index: deleteIndex };
          todos.splice(deleteIndex, 1);
          debouncedSave();
          renderTodos();
          confirmModal.style.display = 'none';
          deleteIndex = null;
          const audio = new Audio('https://actions.google.com/sounds/v1/ui/click.mp3');
          audio.play();
          undoToast.classList.add('show');
          undoToast.style.display = 'flex';
          setTimeout(() => {
            undoToast.classList.remove('show');
            setTimeout(() => undoToast.style.display = 'none', 300);
          }, 5000);
        }
      });

      cancelDeleteBtn.addEventListener('click', () => {
        confirmModal.style.display = 'none';
        deleteIndex = null;
      });

      todoList.addEventListener('click', e => {
        const li = e.target.closest('li');
        if (!li || e.target.closest('.delete-btn, .edit-btn')) return;
        const realIndex = parseInt(li.dataset.index);
        if (isNaN(realIndex)) return;
        todos[realIndex].completed = !todos[realIndex].completed;
        if (todos[realIndex].completed) {
          todos[realIndex].completedAt = new Date().toISOString();
        } else {
          delete todos[realIndex].completedAt;
        }
        debouncedSave();
        renderTodos();
      });

      undoBtn.addEventListener('click', () => {
        if (deletedTodo && deletedTodo.index !== undefined) {
          todos.splice(deletedTodo.index, 0, deletedTodo);
          deletedTodo = null;
          undoToast.classList.remove('show');
          setTimeout(() => undoToast.style.display = 'none', 300);
          debouncedSave();
          renderTodos();
        }
      });

      document.getElementById('sort-soonest')?.addEventListener('click', () => {
        currentSort = 'soonest';
        renderTodos();
      });

      document.getElementById('sort-furthest')?.addEventListener('click', () => {
        currentSort = 'furthest';
        renderTodos();
      });

      document.getElementById('sort-by-priority')?.addEventListener('click', () => {
        currentSort = 'priority';
        renderTodos();
      });

      priorityFilters.forEach(btn => {
        btn.addEventListener('click', () => {
          priorityFilter = btn.dataset.priority;
          priorityFilters.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderTodos();
        });
      });

      filters.forEach(btn => {
        btn.addEventListener('click', () => setFilter(btn.dataset.filter));
      });

      settingsBtn?.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
      });

      closeSettingsBtn?.addEventListener('click', () => {
        settingsModal.style.display = 'none';
      });

      saveSettingsBtn?.addEventListener('click', () => {
        const theme = themeSelect.value;
        const scheme = schemeSelect.value;
        localStorage.setItem('theme', theme);
        localStorage.setItem('scheme', scheme);
        document.body.setAttribute('data-theme', theme);
        if (scheme !== 'default') {
          document.body.setAttribute('data-scheme', scheme);
        } else {
          document.body.removeAttribute('data-scheme');
        }
        settingsModal.style.display = 'none';
        renderTodos();
      });

      document.addEventListener('click', e => {
        if (e.target === settingsModal) settingsModal.style.display = 'none';
        if (e.target === confirmModal) confirmModal.style.display = 'none';
        if (e.target === editModal) editModal.style.display = 'none';
      });

      updateFilterButtons();
      renderTodos();
    });
  </script>
</body>
</html>